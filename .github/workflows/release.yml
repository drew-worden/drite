name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.1.0, v1.2.3, etc.

env:
  APP_NAME: Drite

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: macos-latest
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Build executable
      run: make

    - name: Generate icon
      run: make icon

    - name: Create app bundle
      run: make app

    - name: Create DMG
      run: make dmg

    - name: Rename artifacts
      run: |
        mv build/${{ env.APP_NAME }}.dmg build/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg

    - name: Generate checksums
      run: |
        cd build
        shasum -a 256 ${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg > checksums.txt
        cat checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.APP_NAME }} v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          build/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg
          build/checksums.txt
        body: |
          ## ${{ env.APP_NAME }} v${{ steps.version.outputs.version }}

          ### Downloads

          - **macOS**: [${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg)

          ### Installation

          #### macOS
          1. Download the `.dmg` file
          2. Open the DMG and drag ${{ env.APP_NAME }}.app to Applications
          3. Launch ${{ env.APP_NAME }} from Applications or Spotlight

          ### Requirements

          - **macOS**: macOS 13.0 (Ventura) or later

          ### Checksums

          See `checksums.txt` for SHA-256 hashes.

          ---

          Built with ❤️ by Drew Worden
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
