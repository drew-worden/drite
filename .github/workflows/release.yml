name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.1.0, v1.2.3, etc.

env:
  APP_NAME: Drite

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: macos-latest
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Build executable
      run: make

    - name: Generate icon
      run: make icon

    - name: Create app bundle
      run: make app

    - name: Create DMG
      run: make dmg

    - name: Remove quarantine attributes (for unsigned apps)
      run: |
        xattr -cr build/${{ env.APP_NAME }}.app
        echo "Removed quarantine attributes from app bundle"

    - name: Rename artifacts
      run: |
        mv build/${{ env.APP_NAME }}.dmg build/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg

    - name: Generate checksums
      run: |
        cd build
        shasum -a 256 ${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg > checksums.txt
        cat checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.APP_NAME }} v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          build/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg
          build/checksums.txt
        body: |
          ## ${{ env.APP_NAME }} v${{ steps.version.outputs.version }}

          ### Downloads

          - **macOS**: [${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macOS.dmg)

          ### Installation

          #### macOS
          1. Download the `.dmg` file
          2. Open the DMG and drag ${{ env.APP_NAME }}.app to Applications
          3. (Optional) Double-click `Install CLI Tool.command` to install the `drite` command for terminal use
          4. Launch ${{ env.APP_NAME }} from Applications or Spotlight

          ### Important: Unsigned Application Warning

          This application is not code-signed or notarized. macOS Gatekeeper will show security warnings when you try to run it.

          #### First Launch - "Cannot Be Opened" Warning

          When you first try to open ${{ env.APP_NAME }}.app, you may see:
          > "${{ env.APP_NAME }}.app cannot be opened because it is from an unidentified developer."

          **Solution 1: Right-Click Method**
          1. Right-click (or Control-click) on ${{ env.APP_NAME }}.app in Applications
          2. Select "Open" from the context menu
          3. Click "Open" in the security dialog
          4. The app will now run and be remembered as safe

          **Solution 2: System Settings**
          1. Try to open the app normally (it will be blocked)
          2. Go to **System Settings → Privacy & Security**
          3. Scroll down to the "Security" section
          4. Click **"Open Anyway"** next to the message about ${{ env.APP_NAME }}
          5. Confirm by clicking "Open" in the dialog

          **Solution 3: Command Line (Advanced)**
          ```bash
          # Remove quarantine attribute from the app
          xattr -cr /Applications/${{ env.APP_NAME }}.app
          ```

          #### CLI Tool Installation Warnings

          If you double-click `Install CLI Tool.command` from the DMG, you may see:
          > "Install CLI Tool.command cannot be opened because it is from an unidentified developer."

          **Solution:**
          1. Right-click on `Install CLI Tool.command` and select "Open"
          2. Click "Open" in the security dialog
          3. The installer will run in Terminal and prompt for your password

          **Alternative: Manual CLI Installation**
          ```bash
          # Copy the CLI tool manually
          sudo cp /Applications/${{ env.APP_NAME }}.app/Contents/Resources/bin/drite /usr/local/bin/drite
          sudo chmod +x /usr/local/bin/drite
          ```

          After installation, you can run `drite` from any terminal.

          ### Requirements

          - **macOS**: macOS 13.0 (Ventura) or later

          ### Checksums

          See `checksums.txt` for SHA-256 hashes.

          ---

          Built with ❤️ by Drew Worden
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
